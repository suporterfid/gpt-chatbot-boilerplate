# Audit Trails Documentation

## Overview

The audit trails feature provides a comprehensive, private, and secure audit trail for all conversations generated by system agents. This enables:

- **Hallucination Detection**: Identify when models produce unreliable or unsupported responses
- **Operational Monitoring**: Track failures, fallbacks, and system health
- **Post-Incident Analysis**: Reconstruct what happened during specific interactions
- **Compliance**: Meet data retention and audit requirements
- **Quality Assurance**: Review and evaluate conversation quality

## Architecture

The audit system consists of several components:

1. **AuditService**: Core service for persisting audit data
2. **PIIRedactor**: Redacts personally identifiable information before storage
3. **CryptoAdapter**: Encrypts/decrypts conversation content at rest
4. **Database Schema**: Four tables for conversations, messages, events, and artifacts
5. **Admin API**: Endpoints for querying and managing audit data
6. **Retention Cleanup**: Automated deletion of expired audit records

## Database Schema

### audit_conversations
Stores conversation-level metadata:
- `id`: Unique audit conversation ID
- `agent_id`: ID of the agent handling the conversation
- `channel`: Communication channel (web, whatsapp, etc.)
- `conversation_id`: Original conversation ID from chat system
- `user_fingerprint`: Hashed user identifier
- `started_at`, `last_activity_at`: Timestamps
- `meta_json`: Additional metadata (JSON)

### audit_messages
Stores individual messages:
- `id`: Unique message ID
- `conversation_id`: Foreign key to audit_conversations
- `sequence`: Message order within conversation
- `role`: Message role (system, user, assistant, tool)
- `content_enc`: Encrypted/redacted message content
- `content_hash`: SHA-256 hash of redacted plaintext
- `attachments_json`: File IDs and attachments (JSON)
- `request_meta_json`: Request parameters (model, temperature, etc.)
- `response_meta_json`: Response metadata (latency, tokens, etc.)
- `risk_scores_json`: Hallucination risk and evaluation results
- `created_at`: Timestamp

### audit_events
Stores lifecycle events:
- `id`: Unique event ID
- `conversation_id`: Foreign key to audit_conversations
- `message_id`: Optional foreign key to audit_messages
- `type`: Event type (request_start, stream_end, tool_call, fallback_applied, etc.)
- `payload_json`: Event-specific data (JSON)
- `created_at`: Timestamp

### audit_artifacts
Stores retrieval context and tool artifacts:
- `id`: Unique artifact ID
- `message_id`: Foreign key to audit_messages
- `kind`: Artifact type (retrieval_context, tool_input, tool_output)
- `data_json`: Artifact data (JSON)
- `created_at`: Timestamp

## Configuration

Add these environment variables to your `.env` file:

```bash
# Enable/disable audit trails
AUDIT_ENABLED=true

# Encrypt content at rest
AUDIT_ENCRYPT=true

# Encryption key (minimum 32 characters)
AUDIT_ENC_KEY=your_random_encryption_key_here_min_32_chars

# Retention period in days
AUDIT_RETENTION_DAYS=90

# Custom PII redaction patterns (optional)
# Format: name:regex:replacement or JSON
AUDIT_PII_PATTERNS=

# Sampling rate (0.0 to 1.0)
AUDIT_SAMPLE_RATE=1.0

# Enable async evaluation (optional, future feature)
AUDIT_EVAL_ASYNC=false
```

## Security & Privacy

### PII Redaction
Before storage, all content is scanned for common PII patterns:
- Email addresses → `[EMAIL_REDACTED]`
- Phone numbers → `[PHONE_REDACTED]`
- Credit card numbers → `[CARD_REDACTED]`
- Social Security Numbers → `[SSN_REDACTED]`
- IP addresses → `[IP_REDACTED]`

Custom patterns can be configured via `AUDIT_PII_PATTERNS`.

### Encryption at Rest
When `AUDIT_ENCRYPT=true`, message content is encrypted using AES-256-GCM before storage. The encryption key is derived from `AUDIT_ENC_KEY`.

Each encrypted message includes:
- Ciphertext (base64-encoded)
- Nonce (12 bytes, base64-encoded)
- Authentication tag (16 bytes, base64-encoded)

### Content Hashing
All content is hashed (SHA-256) after redaction to enable:
- De-duplication detection
- Forensic analysis without exposing content
- Verification of data integrity

### Access Control
Audit data is accessible only through admin API endpoints requiring:
- Valid admin authentication token
- Appropriate RBAC permissions
- `read_sensitive_audit` permission for decrypted content

## Event Types

The audit system captures various event types:

| Event Type | Description |
|------------|-------------|
| `request_start` | User request initiated |
| `request_end` | Synchronous request completed |
| `stream_start` | Streaming response started |
| `stream_end` | Streaming response completed |
| `tool_call` | Tool/function called during response |
| `tool_output` | Tool/function execution result |
| `fallback_applied` | System fallback triggered (prompt removal, model downgrade) |
| `validation_error` | Input validation failed |
| `error` | General error occurred |

## Admin API Endpoints

### List Conversations
```
GET /admin-api.php?action=list_audit_conversations
```

Query parameters:
- `agent_id`: Filter by agent ID
- `channel`: Filter by channel (web, whatsapp, etc.)
- `from`: Filter by start date (ISO 8601)
- `to`: Filter by end date (ISO 8601)
- `limit`: Max results (default: 50, max: 500)
- `offset`: Pagination offset

Response:
```json
{
  "conversations": [
    {
      "id": "uuid",
      "agent_id": "agent_123",
      "channel": "web",
      "conversation_id": "conv_abc123",
      "user_fingerprint": "hashed_value",
      "started_at": "2025-11-06T00:00:00Z",
      "last_activity_at": "2025-11-06T00:05:00Z",
      "meta_json": "{...}"
    }
  ]
}
```

### Get Conversation Details
```
GET /admin-api.php?action=get_audit_conversation&conversation_id=conv_123
```

Query parameters:
- `conversation_id`: (required) Conversation ID
- `decrypt`: Set to `true` to decrypt content (requires `read_sensitive_audit` permission)

Response:
```json
{
  "conversation": {...},
  "messages": [
    {
      "id": "uuid",
      "role": "user",
      "content_enc": "encrypted_or_redacted",
      "content_hash": "sha256_hash",
      "sequence": 1,
      "request_meta_json": "{...}",
      "response_meta_json": "{...}",
      "created_at": "2025-11-06T00:00:00Z"
    }
  ],
  "events": [
    {
      "id": "uuid",
      "type": "request_start",
      "payload_json": "{...}",
      "created_at": "2025-11-06T00:00:00Z"
    }
  ]
}
```

### Get Message Details
```
GET /admin-api.php?action=get_audit_message&message_id=msg_123
```

Query parameters:
- `message_id`: (required) Message ID
- `decrypt`: Set to `true` to decrypt content (requires `read_sensitive_audit` permission)

### Export Audit Data
```
GET /admin-api.php?action=export_audit_data
```

Query parameters:
- `agent_id`: Filter by agent ID
- `from`: Filter by start date (ISO 8601)
- `to`: Filter by end date (ISO 8601)

Returns CSV file with conversation metadata.

### Delete Audit Data
```
POST /admin-api.php?action=delete_audit_data
```

Request body:
```json
{
  "conversation_id": "conv_123"  // Delete specific conversation
}
```

OR

```json
{
  "retention_days": 90  // Delete all conversations older than N days
}
```

## Retention Management

### Automated Cleanup
Run the retention cleanup script as a cron job:

```bash
# Run daily at 2 AM
0 2 * * * cd /path/to/project && php scripts/audit_retention_cleanup.php >> logs/retention.log 2>&1
```

The script deletes conversations older than `AUDIT_RETENTION_DAYS`, except those with a `hold_until` field in their metadata.

### Legal Holds
To prevent automatic deletion of specific conversations:

```php
// Set hold_until date in conversation metadata
$auditService->startConversation(
    $agentId,
    $channel,
    $conversationId,
    $userFingerprint,
    ['hold_until' => '2026-01-01T00:00:00Z']
);
```

## Hallucination & Failure Detection

The audit system captures signals that may indicate hallucinations or failures:

### Synchronous Signals (Captured Automatically)
- **Fallbacks**: Prompt unavailable, model unsupported
- **HTTP Errors**: 4xx/5xx responses from OpenAI
- **Empty Responses**: No content generated
- **Tool Consistency**: Tool called but output ignored

### Response Metadata
Each assistant message includes:
- `finish_reason`: How the response concluded
- `latency_ms`: Response generation time
- `http_status`: OpenAI API HTTP status code
- `response_id`: OpenAI response/completion ID

### Future: Async Evaluation (Optional)
The `risk_scores_json` field is reserved for future async evaluation:
- Hallucination risk score (low/medium/high)
- Factual support assessment
- Policy compliance flags

## Integration Examples

### Chat-Unified.php
Audit hooks are automatically integrated when the service is enabled:

```php
// Correlation ID assigned per request
$correlationId = uniqid('req_', true);

// Conversation started
$auditService->startConversation($agentId, 'web', $conversationId, $userFingerprint, [...]);

// Validation errors captured
$auditService->recordEvent($conversationId, 'validation_error', [...]);

// Errors captured
$auditService->recordEvent($conversationId, 'error', [...]);
```

### ChatHandler
All API flows (Chat Completions and Responses API, streaming and sync) capture:

```php
// User message appended
$auditService->appendMessage($conversationId, [...]);

// Events recorded
$auditService->recordEvent($conversationId, 'request_start', [...]);
$auditService->recordEvent($conversationId, 'stream_start', [...]);
$auditService->recordEvent($conversationId, 'tool_call', [...]);

// Assistant message finalized
$auditService->finalizeMessage($messageId, $responseMeta, $riskScores);
```

## Best Practices

1. **Encryption Key**: Use a strong, random 32+ character key and store it securely
2. **Retention Period**: Set based on compliance requirements (e.g., 90 days)
3. **Regular Cleanup**: Schedule the retention cleanup script to run daily
4. **Access Control**: Limit `read_sensitive_audit` permission to authorized personnel
5. **Monitoring**: Monitor audit service logs for errors or failures
6. **PII Patterns**: Customize redaction patterns for domain-specific PII
7. **Sampling**: Use `AUDIT_SAMPLE_RATE < 1.0` for high-volume systems if needed

## Troubleshooting

### Audit Service Not Recording
- Check `AUDIT_ENABLED=true` in `.env`
- Verify database migrations ran successfully
- Check logs for initialization errors

### Decryption Failures
- Verify `AUDIT_ENC_KEY` matches the key used during encryption
- Check that encryption was enabled when data was written
- Ensure OpenSSL extension is installed and enabled

### High Storage Usage
- Review and adjust `AUDIT_RETENTION_DAYS`
- Run retention cleanup script manually
- Consider using sampling for high-volume systems

### Missing Events
- Ensure audit service is initialized in chat-unified.php
- Check for exceptions during audit operations (logged but non-blocking)
- Verify database table integrity

## Performance Considerations

- Audit operations are **non-blocking**: failures don't interrupt user requests
- Database writes are **synchronous** but lightweight
- Encryption/decryption overhead is minimal (AES-256-GCM)
- Indexes optimize common query patterns
- Consider database performance tuning for high-volume deployments

## Compliance Notes

The audit system supports common compliance requirements:

- **Data Retention**: Configurable retention period with automated cleanup
- **Data Privacy**: PII redaction and encryption at rest
- **Access Control**: RBAC with granular permissions
- **Audit Trail**: Immutable record of all interactions
- **Right to Deletion**: Manual deletion via admin API
- **Legal Holds**: Prevent automated deletion when required

Consult with your legal and compliance teams to ensure proper configuration for your specific requirements.
